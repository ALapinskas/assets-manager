export class AssetsManager{#e;#t;#i;#s;#a;#n;#o;#r;#d;constructor(){this.#e=new Map,this.#t=new Map,this.#i=new Map,this.#s=new Map,this.#a=[],this.#n=[],this.#o=[],this.#r=void 0,this.#d=!1}getAudio(e){const t=this.#e.get(e);if(t)return t;Warning("Audio with key '"+e+"' is not registered")}getImage(e){const t=this.#t.get(e);if(t)return t;Warning("Image with key '"+e+"' is not registered")}getTileMap(e){const t=this.#s.get(e);if(t)return t;Warning("Tilemap with key '"+e+"' is not registered")}getTilesetImageArray(e){return this.#i.get(e)}preload(){return this.#r=!0,Promise.allSettled(this.#a).then((e=>(e.forEach((e=>{"rejected"===e.status&&Warning(e.reason||e.value)})),this.#a=[],Promise.allSettled(this.#o).then((e=>(e.forEach((e=>{"rejected"===e.status&&Warning(e.reason||e.value)})),this.#o=[],Promise.allSettled(this.#n).then((e=>(e.forEach((e=>{"rejected"===e.status&&Warning(e.reason||e.value)})),this.#n=[],this.#d=!0,this.#r=!1,Promise.resolve())))))))))}get isLoading(){return this.#r}get isAllFilesLoaded(){return this.#d}addAudio(e,t){this.#l(e,t);const i=this.#u(e,t);this.#a.push(i)}addImage(e,t){this.#l(e,t);const i=this.#h(e,t);this.#n.push(i)}addTileMap(e,t){this.#l(e,t);const i=new Promise(((i,s)=>{fetch(t).then((e=>e.json())).then((s=>{let a,n=t.split("/"),o=n.length;"1.9"===!s.version&&Warning("Not tested with version: "+s.version),n[o-1].includes(".tmj")||n[o-1].includes(".json")?(n.pop(),a=n.join("/")+"/"):(n[o-2].includes(".tmj")||n[o-2].includes(".json"))&&(n.splice(o-2,2),a=n.join("/")+"/"),this.#g(e,s),console.log("tilemap was added"),s.tilesets&&s.tilesets.length>0&&s.tilesets.forEach(((t,s)=>{this.#c(t,a).then((t=>{this.#m(e,s,t),i()}))}))})).catch((e=>{s(e)}))}));this.#o.push(i)}#c(e,t){const{firstgid:i,source:s}=e;return fetch(t+s).then((e=>e.json())).then((e=>{const{name:s,image:a}=e;return s&&a&&this.addImage(s,t?t+a:a,e),e.gid=i,Promise.resolve(e)})).catch((e=>Promise.reject(e)))}#u(e,t){return new Promise(((i,s)=>{const a=new Audio(t);a.addEventListener("loadeddata",(()=>{this.#p(e,a),i()})),a.addEventListener("error",(e=>{s(e)}))}))}#h(e,t){return new Promise(((i,s)=>{const a=new Image;a.onload=()=>{createImageBitmap(a).then((t=>{this.#w(e,t),i()}))},a.onerror=e=>{s(e)},a.src=t}))}#I(e,t,i){const{tilecount:s,columns:a,tilewidth:n,tileheight:o}=i;return new Promise(((i,r)=>{const d=new Image;d.onload=()=>{const t=[];let r=0,l=0;for(let e=0;e<s;e++)0!==e&&(e%a==0?(r+=1,l=0):l+=1),t.push(createImageBitmap(d,l*o,r*n,n,o));Promise.allSettled(t).then((t=>{let s=[];t.forEach((e=>{"rejected"===e.status&&Warning(e.reason||e.value),s.push(e.value)})),this.#v(e,s),i()}))},d.onerror=e=>{r(e)},d.src=t}))}#l(e,t){e&&0!==e.trim().length||Exception("key should be provided"),t&&0!==t.trim().length||Exception("image url should be provided")}#p(e,t){this.#e.set(e,t)}#w(e,t){this.#t.set(e,t)}#v(e,t){this.#i.set(e,t)}#m(e,t,i){this.#s.get(e).tilesets[t].data=i}#g(e,t){this.#s.set(e,t)}}function Exception(e){throw new Error(e)}function Warning(e){console.warn(e)}
